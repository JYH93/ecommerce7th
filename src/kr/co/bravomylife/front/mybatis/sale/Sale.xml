<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.bravomylife.front.mybatis.sale.Sale">

	<select id="totalCount" parameterType="pagingDto" resultType="java.lang.Integer">
		SELECT
			COUNT(ROWNUM)
		FROM
			TB_SLE sle
		WHERE
			<include refid="totalwhere" />
	</select>

	<select id="totalList" parameterType="pagingDto" resultType="saleDto">
		SELECT
			*
		FROM
			(
			SELECT
				/*+ first_rows(10) */ ROW_NUMBER() OVER (ORDER BY best.FLG_BEST, sle.DT_REG DESC) rnum
				, sle.SEQ_SLE
				, sle.SLE_NM
				, sle.IMG
				, sle.PRICE_SALE
				, sle.CD_CTG_B
				, sle.CD_CTG_M
				, rate.RATE_STAR
				, rate.COUNT
				, ROUND(rate.RATE_STAR * 1.0 / rate.COUNT, 0) average_rate
				, sle.PRD_TYPE
				, sle.CORP_NM
				, sle.DISCOUNT
				, sle.COUNT_STOCK
				, sle.PRICE_SALE * (1 - (sle.DISCOUNT / 100)) discount_sale
				, TO_CHAR(sle.DT_REG, 'YYYY-MM-DD') DT_REG
				, best.FLG_BEST
			FROM
				TB_SLE sle
			LEFT JOIN
				TB_RATE rate
			ON
				sle.SEQ_SLE = rate.SEQ_SLE
			LEFT JOIN
				TB_BEST best
			on
				sle.SEQ_SLE = best.SEQ_SLE
			WHERE
				<include refid="totalwhere" />
			)
		<![CDATA[
		WHERE rnum >= (${currentPage} - 1) * ${linePerPage} + 1 AND rnum <= ${currentPage} * ${linePerPage}
		]]> 
		ORDER BY FLG_BEST, rnum
	</select>
	
	<sql id="totalwhere">
		sle.CD_STATE_SALE = 2
		AND sle.FLG_DELETE = 'N'
		<![CDATA[
		AND sle.COUNT_STOCK > 0
		]]> 
		<if test="searchWord != null and searchWord != ''">
			<if test="searchKey == 'prd_nm'">
				AND sle.CORP_NM LIKE '%' || #{searchWord} || '%'
			</if>
		</if>
	</sql>
	
	<select id="ingredientCount" parameterType="pagingDto" resultType="java.lang.Integer">
		SELECT
			COUNT(ROWNUM)
		FROM
			TB_SLE sle
		WHERE
			<include refid="ingredientwhere" />
	</select>
	
	<select id="ingredientList" parameterType="pagingDto" resultType="saleDto">
		SELECT
			*
		FROM
			(
			SELECT
				/*+ first_rows(10) */ ROW_NUMBER() OVER (ORDER BY best.FLG_BEST, sle.DT_REG DESC) rnum
				, sle.SEQ_SLE
				, sle.SLE_NM
				, sle.IMG
				, sle.PRICE_SALE
				, sle.CD_CTG_B
				, sle.CD_CTG_M
				, rate.RATE_STAR
				, rate.COUNT
				, ROUND(rate.RATE_STAR * 1.0 / rate.COUNT, 0) average_rate
				, sle.PRD_TYPE
				, sle.CORP_NM
				, sle.DISCOUNT
				, sle.COUNT_STOCK
				, sle.PRICE_SALE * (1 - (sle.DISCOUNT / 100)) discount_sale
				, TO_CHAR(sle.DT_REG, 'YYYY-MM-DD') DT_REG
				, best.FLG_BEST
			FROM
				TB_SLE sle
			LEFT JOIN
				TB_RATE rate
			ON
				sle.SEQ_SLE = rate.SEQ_SLE
			LEFT JOIN
				TB_BEST best
			on
				sle.SEQ_SLE = best.SEQ_SLE
			WHERE
				<include refid="ingredientwhere" />
			)
		<![CDATA[
		WHERE rnum >= (${currentPage} - 1) * ${linePerPage} + 1 AND rnum <= ${currentPage} * ${linePerPage}
		]]> 
		ORDER BY FLG_BEST, rnum
	</select>
	
	<sql id="ingredientwhere">
		sle.CD_STATE_SALE = 2
		AND sle.FLG_DELETE = 'N'
		AND sle.CD_CTG_B = '2'
		<![CDATA[
		AND sle.COUNT_STOCK > 0
		]]> 
		<if test="searchWord != null and searchWord != ''">
			<if test="searchKey == 'prd_nm'">
				AND sle.CORP_NM LIKE '%' || #{searchWord} || '%'
			</if>
		</if>
	</sql>
	
	<select id="functionCount" parameterType="pagingDto" resultType="java.lang.Integer">
		SELECT
			COUNT(ROWNUM)
		FROM
			TB_SLE sle
		WHERE
			<include refid="functionwhere" />
	</select>
	
	<select id="functionList" parameterType="pagingDto" resultType="saleDto">
		SELECT
			*
		FROM
			(
			SELECT
				/*+ first_rows(10) */ ROW_NUMBER() OVER (ORDER BY best.FLG_BEST, sle.DT_REG DESC) rnum
				, sle.SEQ_SLE
				, sle.SLE_NM
				, sle.IMG
				, sle.PRICE_SALE
				, sle.CD_CTG_B
				, sle.CD_CTG_M
				, rate.RATE_STAR
				, rate.COUNT
				, ROUND(rate.RATE_STAR * 1.0 / rate.COUNT, 0) average_rate
				, sle.PRD_TYPE
				, sle.CORP_NM
				, sle.DISCOUNT
				, sle.COUNT_STOCK
				, sle.PRICE_SALE * (1 - (sle.DISCOUNT / 100)) discount_sale
				, TO_CHAR(sle.DT_REG, 'YYYY-MM-DD') DT_REG
				, best.FLG_BEST
			FROM
				TB_SLE sle
			LEFT JOIN
				TB_RATE rate
			ON
				sle.SEQ_SLE = rate.SEQ_SLE
			LEFT JOIN
				TB_BEST best
			on
				sle.SEQ_SLE = best.SEQ_SLE
			WHERE
				<include refid="functionwhere" />
			)
		<![CDATA[
		WHERE rnum >= (${currentPage} - 1) * ${linePerPage} + 1 AND rnum <= ${currentPage} * ${linePerPage}
		]]> 
		ORDER BY FLG_BEST, rnum
	</select>
	
	<sql id="functionwhere">
		sle.CD_STATE_SALE = 2
		AND sle.FLG_DELETE = 'N'
		AND sle.CD_CTG_B = '1'
		<![CDATA[
		AND sle.COUNT_STOCK > 0
		]]> 
		<if test="searchWord != null and searchWord != ''">
			<if test="searchKey == 'prd_nm'">
				AND sle.CORP_NM LIKE '%' || #{searchWord} || '%'
			</if>
		</if>
	</sql>
	
	<select id="genderCount" parameterType="pagingDto" resultType="java.lang.Integer">
		SELECT
			COUNT(ROWNUM)
		FROM
			TB_SLE sle
		WHERE
			<include refid="genderwhere" />
	</select>
	
	<select id="genderList" parameterType="pagingDto" resultType="saleDto">
		SELECT
			*
		FROM
			(
			SELECT
				/*+ first_rows(10) */ ROW_NUMBER() OVER (ORDER BY best.FLG_BEST, sle.DT_REG DESC) rnum
				, sle.SEQ_SLE
				, sle.SLE_NM
				, sle.IMG
				, sle.PRICE_SALE
				, sle.CD_CTG_B
				, sle.CD_CTG_M
				, rate.RATE_STAR
				, rate.COUNT
				, ROUND(rate.RATE_STAR * 1.0 / rate.COUNT, 0) average_rate
				, sle.PRD_TYPE
				, sle.CORP_NM
				, sle.DISCOUNT
				, sle.COUNT_STOCK
				, sle.PRICE_SALE * (1 - (sle.DISCOUNT / 100)) discount_sale
				, TO_CHAR(sle.DT_REG, 'YYYY-MM-DD') DT_REG
				, best.FLG_BEST
			FROM
				TB_SLE sle
			LEFT JOIN
				TB_RATE rate
			ON
				sle.SEQ_SLE = rate.SEQ_SLE
			LEFT JOIN
				TB_BEST best
			on
				sle.SEQ_SLE = best.SEQ_SLE
			WHERE
				<include refid="genderwhere" />
			)
		<![CDATA[
		WHERE rnum >= (${currentPage} - 1) * ${linePerPage} + 1 AND rnum <= ${currentPage} * ${linePerPage}
		]]> 
		ORDER BY FLG_BEST, rnum
	</select>
	
	<sql id="genderwhere">
		sle.CD_STATE_SALE = 2
		AND sle.FLG_DELETE = 'N'
		AND sle.CD_CTG_B = '3'
		<![CDATA[
		AND sle.COUNT_STOCK > 0
		]]> 
		<if test="searchWord != null and searchWord != ''">
			<if test="searchKey == 'prd_nm'">
				AND sle.CORP_NM LIKE '%' || #{searchWord} || '%'
			</if>
		</if>
	</sql>
		
</mapper>